åŸæ–‡ï¼šhttps://react.dev/reference/react/useState

# useState
`useState`æ˜¯Reactçš„ä¸€ä¸ªHookï¼Œå®ƒèƒ½è®©ä½ åœ¨ä½ çš„ç»„ä»¶ä¸­æ·»åŠ ä¸€ä¸ª`state`å˜é‡ã€‚

```javascript
const [state, setState] = useState(initialState);
```

## å¼•è¨€
### useState(initialState)
åœ¨ä½ çš„ç»„ä»¶çš„é¡¶å±‚è°ƒç”¨`useState`ï¼Œæ¥å®šä¹‰ä¸€ä¸ª`state`å˜é‡ã€‚

```javascript
import { useState } from 'react';

function MyComponent() {
  const [age, setAge] = useState(28);
  const [name, setName] = useState('Taylor');
  const [todos, setTodos] = useState(() => createTodos());
  // ...
}
```

ä¹ æƒ¯ä¸Šä¼šä½¿ç”¨æ•°ç»„ç»“æ„æ¯”å¦‚`[something,setSomething]`æ¥å‘½å`state`å˜é‡ã€‚

#### å‚æ•°
- `initialState`ï¼šä½ å¸Œæœ›`state`åˆå§‹åŒ–ä¸ºä»€ä¹ˆçš„å€¼ã€‚å®ƒå¯ä»¥æ˜¯ä»»ä½•ç±»å‹ï¼Œä½†å¯¹äºå‡½æ•°æœ‰ç‰¹æ®Šçš„è¡Œä¸ºã€‚è¿™ä¸ªå‚æ•°ä¼šåœ¨åˆå§‹åŒ–æ¸²æŸ“åè¢«å¿½ç•¥ã€‚ 
å¦‚æœä½ å°†å‡½æ•°ä½œä¸º`initialState`æ¥ä¼ é€’ï¼Œå®ƒä¼šè¢«è§†ä¸ºåˆå§‹åŒ–å‡½æ•°ã€‚å®ƒåº”è¯¥æ˜¯çº¯å‡½æ•°ï¼Œä¸æ¥å—å‚æ•°ï¼Œè€Œä¸”åº”è¯¥è¿”å›ä¸€ä¸ªä»»æ„ç±»å‹çš„å€¼ã€‚Reactä¼šåœ¨åˆå§‹åŒ–ç»„ä»¶æ—¶ï¼Œè°ƒç”¨ä½ çš„åˆå§‹åŒ–å‡½æ•°ï¼Œç„¶åæŠŠå®ƒçš„è¿”å›å€¼å­˜å‚¨ä¸ºåˆå§‹`state`ã€‚

#### è¿”å›å€¼
`useState`è¿”å›ä¸€ä¸ªæœ‰ä»¥ä¸‹ä¸¤ä¸ªå€¼çš„æ•°ç»„ï¼š
1. å½“å‰`state`ã€‚ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œå®ƒæ˜¯ä½ ä¼ é€’çš„`initialState`ã€‚
2. `set function`å…è®¸ä½ å°†`state`æ›´æ–°ä¸ºä¸€ä¸ªä¸åŒçš„å€¼ï¼Œå¹¶è§¦å‘é‡æ–°æ¸²æŸ“ã€‚

#### è­¦å‘Š
- `useState`æ˜¯ä¸ªHookï¼Œæ‰€ä»¥ä½ åªèƒ½åœ¨ç»„ä»¶çš„é¡¶å±‚æˆ–è€…ä½ çš„è‡ªå®šä¹‰Hookä¸­è°ƒç”¨å®ƒã€‚ä¸èƒ½åœ¨å¾ªç¯å†…æˆ–æ¡ä»¶è¯­å¥ä¸­è°ƒç”¨å®ƒã€‚å¦‚æœéœ€è¦ï¼Œå¯ä»¥æå–ä¸€ä¸ªæ–°ç»„ä»¶ï¼Œå¹¶æŠŠ`state`ç§»åˆ°æ–°ç»„ä»¶ä¸­ã€‚
- åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼ŒReactä¼šè°ƒç”¨ä½ çš„åˆå§‹åŒ–å‡½æ•°ä¸¤æ¬¡ï¼Œä¸ºäº†å¸®ä½ å‘ç°å¶ç„¶çš„ä¸çº¯ã€‚è¿™æ˜¯åªåœ¨å¼€å‘ç¯å¢ƒä¸‹çš„è¡Œä¸ºï¼Œè€Œä¸”ä¸ä¼šåœ¨ç”Ÿäº§ç¯å¢ƒå‘ç”Ÿã€‚å¦‚æœä½ çš„åˆå§‹åŒ–å‡½æ•°æ˜¯çº¯çš„ï¼ˆæœ¬å°±åº”è¯¥è¿™æ ·ï¼‰ï¼Œå®ƒä¸ä¼šå½±å“è¡Œä¸ºã€‚å…¶ä¸­ä¸€ä¸ªè°ƒç”¨ç»“æœä¼šè¢«å¿½ç•¥ã€‚

### `set`å‡½æ•°ï¼Œæ¯”å¦‚`setSomething(nextState)`
`set`å‡½æ•°é€šè¿‡`useState`è¿”å›ï¼Œè®©ä½ å°†`state`æ›´æ–°ä¸ºä¸€ä¸ªä¸åŒçš„å€¼ï¼Œå¹¶è§¦å‘é‡æ–°æ¸²æŸ“ã€‚ä½ å¯ä»¥ç›´æ¥ä¼ é€’ä¸‹ä¸€ä¸ª`state`ï¼Œæˆ–è€…é€šè¿‡ä¸€ä¸ªå‡½æ•°ä»å‰ä¸€ä¸ª`state`è®¡ç®—å®ƒï¼š

```javascript
const [name, setName] = useState('Edward');

function handleClick() {
  setName('Taylor');
  setAge(a => a + 1);
  // ...
}
```

#### å‚æ•°
- `nextState`ï¼šä½ å¸Œæœ›`state`å˜æˆä»€ä¹ˆçš„å€¼ã€‚å®ƒå¯ä»¥æ˜¯ä»»ä½•ç±»å‹ï¼Œä½†å¯¹äºå‡½æ•°æœ‰ç‰¹æ®Šçš„è¡Œä¸ºã€‚
å¦‚æœä½ ä¼ é€’ä¸€ä¸ªå‡½æ•°ä½œä¸º`nextState`,å®ƒä¼šæŠŠå®ƒçœ‹åšä¸€ä¸ªæ›´æ–°å‡½æ•°ã€‚å®ƒå¿…é¡»æ˜¯çº¯çš„ï¼Œåº”è¯¥åªèƒ½æŠŠå¾…å¤„ç†çš„`state`ä½œä¸ºå®ƒå”¯ä¸€çš„å‚æ•°ï¼Œç„¶åè¿”å›ä¸‹ä¸€ä¸ª`state`ã€‚Reactä¼šæŠŠä½ çš„æ›´æ–°å‡½æ•°æ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åé‡æ–°æ¸²æŸ“ä½ çš„ç»„ä»¶ã€‚åœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“çš„è¿‡ç¨‹ä¸­ï¼ŒReactä¼šæ ¹æ®å‰ä¸€ä¸ª`state`é€šè¿‡æ‰€æœ‰æ’é˜Ÿçš„æ›´æ–°å‡½æ•°è®¡ç®—ä¸‹ä¸€ä¸ª`state`ã€‚

#### è¿”å›å€¼
`set`å‡½æ•°æ²¡æœ‰è¿”å›å€¼

#### è­¦å‘Š
- `set`å‡½æ•°åªä¼šåœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“æ—¶æ›´æ–°`state`å˜é‡ã€‚å¦‚æœä½ åœ¨è°ƒç”¨`set`å‡½æ•°åè¯»å–`state`å˜é‡ï¼Œä½ ä»ç„¶ä¼šåœ¨å±å¹•ä¸Šå¾—åˆ°è°ƒç”¨ä¹‹å‰çš„æ—§å€¼ã€‚
- å¦‚æœä½ æä¾›çš„æ–°å€¼è·Ÿç°åœ¨çš„`state`ç”±`Object.is`åˆ¤æ–­ä¸ºå®Œå…¨ç›¸åŒï¼ŒReactä¼šè·³è¿‡ç»„ä»¶å’Œå®ƒå­ç»„ä»¶çš„é‡æ¸²æŸ“ã€‚è¿™æ˜¯ä¸ªä¼˜åŒ–ã€‚å°½ç®¡åœ¨ä¸€äº›æƒ…å†µä¸‹Reactä»ç„¶éœ€è¦åœ¨ç•¥è¿‡å­ç»„ä»¶çš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨ä½ çš„ç»„ä»¶ï¼Œä½†å®ƒä¸åº”è¯¥å½±å“ä½ çš„ä»£ç ã€‚
- Reactä¼šæ‰¹é‡æ›´æ–°`state`ã€‚åœ¨æ‰€æœ‰äº‹ä»¶å¤„ç†å™¨å·²ç»è¿è¡Œè€Œä¸”å·²ç»è°ƒç”¨äº†ä»–ä»¬çš„`set`å‡½æ•°ä¹‹åï¼Œå®ƒä¼šæ›´æ–°å±å¹•ã€‚è¿™å¯ä»¥é˜²æ­¢åœ¨å•ä¸ªäº‹ä»¶æœŸé—´è¿›è¡Œå¤šæ¬¡é‡æ¸²æŸ“ã€‚åœ¨æå°‘æ•°æƒ…å†µä¸‹ï¼Œä½ éœ€è¦å¼ºåˆ¶Reactæ›´æ—©çš„æ›´æ–°å±å¹•ï¼Œæ¯”å¦‚è®¿é—®DOMï¼Œä½ å¯ä»¥ä½¿ç”¨`flushSync`ã€‚
- åœ¨æ¸²æŸ“æœŸé—´åªå…è®¸ä»å½“å‰æ¸²æŸ“å‡½æ•°ä¸­è°ƒç”¨`set`å‡½æ•°ã€‚Reactä¼šä¸¢å¼ƒå®ƒçš„è¾“å‡ºï¼Œå¹¶ç«‹åˆ»å°è¯•ä½¿ç”¨æ–°çš„`state`é‡æ–°æ¸²æŸ“å®ƒã€‚å¾ˆå°‘éœ€è¦è¿™ä¸ªæ¨¡å¼ï¼Œä½†æ˜¯ä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥å­˜å‚¨ä¹‹å‰æ¸²æŸ“çš„ä¿¡æ¯ã€‚
- åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼ŒReactä¼šè°ƒç”¨ä¸¤æ¬¡ä½ çš„æ›´æ–°å‡½æ•°ï¼Œä»¥å¸®åŠ©ä½ å‘ç°é—®é¢˜ã€‚æ˜¯åªå­˜åœ¨å¼€å‘ç¯å¢ƒçš„è¡Œä¸ºï¼Œä¸ä¼šåœ¨ç”Ÿäº§ç¯å¢ƒå‡ºç°ã€‚å¦‚æœä½ çš„æ›´æ–°å‡½æ•°æ˜¯çº¯çš„ï¼ˆæœ¬æ¥å°±åº”è¯¥è¿™æ ·ï¼‰ï¼Œè¿™ä¸ä¼šäº§ç”Ÿä»»ä½•å½±å“ã€‚å…¶ä¸­ä¸€ä¸ªç»“æœä¼šè¢«å¿½ç•¥ã€‚

## ä½¿ç”¨
### ç»™ç»„ä»¶æ·»åŠ `state`
åœ¨ç»„ä»¶é¡¶å±‚è°ƒç”¨`useState`æ¥å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ª`state`å˜é‡ã€‚

```javascript
import { useState } from 'react';

function MyComponent() {
  const [age, setAge] = useState(42);
  const [name, setName] = useState('Taylor');
  // ...
}
```

æƒ¯ä¾‹æ˜¯æŠŠ`state`å˜é‡ç”¨æ•°ç»„ç»“æ„å®šä¹‰ä¸º`[something,setSomething]`ã€‚

`useState`è¿”å›ä¸€ä¸ªåŒ…æ‹¬ä¸¤ä¸ªå€¼çš„æ•°ç»„ï¼š
1. è¿™ä¸ª`state`å˜é‡çš„`current state`ï¼Œä½¿ç”¨ä½ æä¾›çš„`initial state`åˆå§‹åŒ–ã€‚
2. `set function`å…è®¸ä½ æŠŠ`state`æ”¹æˆä»»ä½•å…¶ä»–å€¼ä»¥ä»¥å“åº”äº¤äº’ã€‚

ä¸ºäº†æ›´æ–°å±å¹•ä¸Šçš„å†…å®¹ï¼Œè°ƒç”¨`set`å‡½æ•°è®¾ç½®æ–°çš„`state`ï¼š  

```javascript
function handleClick() {
  setName('Robin');
}
```
Reactä¼šå­˜å‚¨æ–°çš„`state`ï¼Œä½¿ç”¨æ–°å€¼é‡æ–°æ¸²æŸ“ç»„ä»¶ï¼Œæ›´æ–°UIã€‚

> é™·é˜±
åœ¨å·²ç»æ‰§è¡Œçš„ä»£ç ä¸­ï¼Œè°ƒç”¨`set`å‡½æ•°ä¸èƒ½æ”¹å˜å½“å‰çš„`state`ï¼š

```javascript
function handleClick() {
setName('Robin');
console.log(name); // Still "Taylor"!
}
```

> å®ƒåªå½±å“`useState`ä»ä¸‹ä¸€æ¬¡æ¸²æŸ“è¿”å›çš„å†…å®¹

### åŸºäºä¹‹å‰çš„`state`æ›´æ–°`state`
å‡è®¾`age`æ˜¯12ï¼Œè¿™ä¸ªå¤„ç†å™¨è°ƒç”¨`setAge(age+1)`ä¸‰æ¬¡ï¼š
```javascript
function handleClick() {
  setAge(age + 1); // setAge(42 + 1)
  setAge(age + 1); // setAge(42 + 1)
  setAge(age + 1); // setAge(42 + 1)
}
```

ä½†æ˜¯ï¼Œç‚¹å‡»ä¸€æ¬¡åï¼Œ`age`ä¼šå˜æˆ43è€Œä¸æ˜¯45ã€‚è¿™æ˜¯å› ä¸ºåœ¨å·²ç»è¿è¡Œä¸­çš„ä»£ç ä¸­ï¼Œè°ƒç”¨`set`å‡½æ•°ä¸ä¼šæ›´æ–°`age`çŠ¶æ€å€¼ã€‚æ‰€ä»¥æ¯æ¬¡çš„`setAge(age+1)`éƒ½å˜æˆäº†`setAge(43)`ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä½ åº”è¯¥ä¼ ä¸€ä¸ªæ›´æ–°å‡½æ•°è€Œä¸æ˜¯ä¸‹ä¸€ä¸ª`state`ç»™`setAge`ã€‚

```javascript
function handleClick() {
  setAge(a => a + 1); // setAge(42 => 43)
  setAge(a => a + 1); // setAge(43 => 44)
  setAge(a => a + 1); // setAge(44 => 45)
}
```

è¿™é‡Œï¼Œ`a=>a+1`æ˜¯ä½ çš„æ›´æ–°å‡½æ•°ã€‚å®ƒæ‹¿åˆ°`pending state`ç„¶åç”¨å®ƒè®¡ç®—`next state`ã€‚

React æŠŠä½ çš„æ›´æ–°å‡½æ•°æ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­ã€‚ç„¶ååœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šç”¨ç›¸åŒçš„é¡ºåºè°ƒç”¨ä»–ä»¬ï¼š
1. `a=>a+1`ä¼šæ‹¿42ä½œä¸ºå¾…å¤„ç†çš„`state`ç„¶åè¿”å›43ä½œä¸ºä¸‹ä¸€ä¸ª`state`
2. `a=>a+1`ä¼šæ‹¿43ä½œä¸ºå¾…å¤„ç†çš„`state`ç„¶åè¿”å›44ä½œä¸ºä¸‹ä¸€ä¸ª`state`
3. `a=>a+1`ä¼šæ‹¿44ä½œä¸ºå¾…å¤„ç†çš„`state`ç„¶åè¿”å›45ä½œä¸ºä¸‹ä¸€ä¸ª`state`

æ²¡æœ‰å…¶ä»–é˜Ÿåˆ—æ›´æ–°ï¼Œå› æ­¤æœ€åReactä¼šæŠŠ45å­˜å‚¨ä¸ºå½“å‰`state`ã€‚

æŒ‰ç…§æƒ¯ä¾‹ï¼Œä¼šç”¨`state`å˜é‡åç§°çš„ç¬¬ä¸€ä¸ªå­—æ¯å‘½åå¾…å¤„ç†çš„`state`å‚æ•°ï¼Œæ¯”å¦‚ç”¨aä»£æ›¿ageã€‚ç„¶è€Œï¼Œä½ ä¹Ÿå¯ä»¥å°†å®ƒå®šä¹‰ä¸º`prevAge`æˆ–å…¶ä»–ã€‚

Reactä¼šåœ¨å¼€å‘ç¯å¢ƒè°ƒç”¨ä¸¤æ¬¡ä½ çš„æ›´æ–°å‡½æ•°ä»¥ç¡®ä¿ä»–ä»¬æ˜¯çº¯çš„ã€‚

> æ·±å…¥æ¢ç´¢
> <br/>
> æ˜¯å¦æ€»æ˜¯é¦–é€‰ä½¿ç”¨æ›´æ–°å‡½æ•°ï¼Ÿ
> <br/>
> ä½ å¯èƒ½å¬è¯´è¿‡ä¸€ä¸ªå»ºè®®ï¼šå¦‚æœä½ è®¾ç½®çš„`state`æ˜¯æ ¹æ®ä¹‹å‰çš„`state`è®¡ç®—å¾—åˆ°çš„ï¼Œæ€»æ˜¯`setAge(a=>a+1)`è¿™æ ·å†™ä»£ç ã€‚è¿™æ˜¯æ²¡æœ‰å±å®³çš„ï¼Œä½†æ˜¯å®ƒä¹Ÿä¸æ€»æ˜¯å¿…é¡»çš„ã€‚
> <br/>
> å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™ä¸¤ç§æ–¹å¼æ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚Reactæ€»ä¼šç¡®ä¿ï¼Œå¯¹äºç”¨æˆ·çš„äº¤äº’æ“ä½œæ¯”å¦‚ç‚¹å‡»ï¼Œ`age`çŠ¶æ€å˜é‡ä¼šåœ¨ä¸‹æ¬¡ç‚¹å‡»å‰æ›´æ–°ã€‚è¿™å°±æ„å‘³ç€


`TODO`

### å­˜å‚¨ä»¥å‰æ¸²æŸ“çš„ä¿¡æ¯
é€šå¸¸ï¼Œä½ ä¼šåœ¨äº‹ä»¶å¤„ç†ç¨‹åºä¸­æ›´æ–°`state`ã€‚ç„¶è€Œï¼Œåœ¨æå°‘æ•°æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½å¸Œæœ›ä¿®æ”¹`state`ä»¥å“åº”æ¸²æŸ“â€”-ä¾‹å¦‚ï¼Œä½ å¯èƒ½å¸Œæœ›åœ¨propå‘ç”Ÿå˜åŒ–æ—¶ä¿®æ”¹`state`å˜é‡ã€‚

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ ä¸éœ€è¦è¿™ä¸ª:

- å¦‚æœä½ éœ€è¦çš„å€¼å®Œå…¨å¯ä»¥ä»å½“å‰çš„propsæˆ–å…¶ä»–`state`ä¸­è®¡ç®—å‡ºæ¥ï¼Œåˆ™å®Œå…¨åˆ é™¤å†—ä½™`state`ã€‚å¦‚æœä½ æ‹…å¿ƒè¿‡äºé¢‘ç¹åœ°é‡æ–°è®¡ç®—ï¼Œå¯ä»¥ä½¿ç”¨`useMemo`ã€‚
- å¦‚æœä½ æƒ³é‡ç½®æ•´ä¸ªç»„ä»¶æ ‘çš„`state`ï¼Œç»™ä½ çš„ç»„ä»¶ä¼ é€’ä¸€ä¸ªä¸åŒçš„`key`ã€‚
- å¦‚æœå¯ä»¥ï¼Œåœ¨äº‹ä»¶å¤„ç†ç¨‹åºä¸­æ›´æ–°æ‰€æœ‰ç›¸å…³çš„`state`ã€‚

åœ¨è¿™äº›éƒ½ä¸é€‚ç”¨çš„ç½•è§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ç§æ¨¡å¼æ¥æ ¹æ®åˆ°ç›®å‰ä¸ºæ­¢å·²ç»å‘ˆç°çš„å€¼æ›´æ–°`state`ï¼Œå³åœ¨ç»„ä»¶æ¸²æŸ“æ—¶è°ƒç”¨`set`å‡½æ•°ã€‚

ä¸¾ä¸ªä¾‹å­ã€‚`CountLabel`ç»„ä»¶æ˜¾ç¤ºä¼ é€’ç»™å®ƒçš„è®¡æ•°é“å…·:

```jsx
export default function CountLabel({ count }) {
  return <h1>{count}</h1>
}
```

å‡è®¾ä½ æƒ³æ˜¾ç¤ºè®¡æ•°å™¨è‡ªä¸Šæ¬¡æ›´æ”¹ä»¥æ¥æ˜¯å¢åŠ äº†è¿˜æ˜¯å‡å°‘äº†ã€‚`count`å‚æ•°ä¸ä¼šå‘Šè¯‰ä½ --ä½ éœ€è¦è·Ÿè¸ªå®ƒä¹‹å‰çš„å€¼ã€‚æ·»åŠ `prevCount``state`å˜é‡æ¥è·Ÿè¸ªå®ƒã€‚æ·»åŠ å¦ä¸€ä¸ªç§°ä¸º`trend`çš„`state`å˜é‡æ¥ä¿æŒè®¡æ•°æ˜¯å¢åŠ è¿˜æ˜¯å‡å°‘ã€‚æ¯”è¾ƒ`prevCount`å’Œ`count`ï¼Œå¦‚æœå®ƒä»¬ä¸ç›¸ç­‰ï¼Œæ›´æ–°`prevCount`å’Œ`trend`ã€‚ç°åœ¨ä½ å¯ä»¥æ˜¾ç¤ºå½“å‰è®¡æ•°å‚æ•°ä»¥åŠè‡ªä¸Šæ¬¡æ¸²æŸ“ä»¥æ¥å®ƒæ˜¯å¦‚ä½•å˜åŒ–çš„ã€‚

```javascript
// App.js
import { useState } from 'react';
import CountLabel from './CountLabel.js';

export default function App() {
  const [count, setCount] = useState(0);
  return (
    <>
      <button onClick={() => setCount(count + 1)}>
        Increment
      </button>
      <button onClick={() => setCount(count - 1)}>
        Decrement
      </button>
      <CountLabel count={count} />
    </>
  );
}
```

```javascript
// CountLabel.js
import { useState } from 'react';

export default function CountLabel({ count }) {
  const [prevCount, setPrevCount] = useState(count);
  const [trend, setTrend] = useState(null);
  if (prevCount !== count) {
    setPrevCount(count);
    setTrend(count > prevCount ? 'increasing' : 'decreasing');
  }
  return (
    <>
      <h1>{count}</h1>
      {trend && <p>The count is {trend}</p>}
    </>
  );
}

```

æ³¨æ„å¦‚æœä½ åœ¨æ¸²æŸ“çš„æ—¶å€™è°ƒç”¨`set`å‡½æ•°ï¼Œå®ƒå¿…é¡»åœ¨ä¸€ä¸ªç±»ä¼¼`prevCount !== count`çš„æ¡ä»¶å†…ï¼Œè€Œä¸”æ¡ä»¶ä¸­å¿…é¡»æœ‰ä¸€ä¸ªç±»ä¼¼`setPrevCount(count) `çš„è°ƒç”¨ã€‚å¦åˆ™ï¼Œä½ çš„ç»„ä»¶å°†ä¼šåœ¨å¾ªç¯ä¸­é‡å¤æ¸²æŸ“ï¼Œç›´è‡³å´©æºƒã€‚è€Œä¸”ï¼Œä½ ä¹Ÿåªèƒ½åƒè¿™æ ·æ›´æ–°å½“å‰æ¸²æŸ“ç»„ä»¶çš„`state`ã€‚åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­è°ƒç”¨å¦ä¸€ä¸ªç»„ä»¶çš„`set`å‡½æ•°æ˜¯ä¸ªé”™è¯¯ã€‚æœ€ç»ˆï¼Œä½ çš„`set`è°ƒç”¨ä»ç„¶ä¼šæ›´æ–°`state`è€Œä¸å‘ç”Ÿå¼‚å˜--è¿™å¹¶ä¸æ„å‘³ç€ä½ å¯ä»¥æ‰“ç ´çº¯å‡½æ•°çš„å…¶ä»–è§„åˆ™ã€‚

è¿™ä¸ªæ¨¡å¼å¾ˆéš¾ç†è§£ï¼Œè€Œä¸”æœ€å¥½é¿å…æ‰ã€‚ä½†æ˜¯ï¼Œå®ƒæ¯”åœ¨effectä¸­æ›´æ–°`state`è¦å¥½ã€‚å½“ä½ åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­è°ƒç”¨`set`å‡½æ•°ï¼Œä½ çš„ç»„ä»¶ç”¨ä¸€ä¸ª`return`è¯­å¥é€€å‡ºæ—¶ï¼Œåœ¨æ¸²æŸ“å­ç»„ä»¶ä¹‹å‰ï¼ŒReactä¼šç«‹å³é‡æ–°æ¸²æŸ“ç»„ä»¶ã€‚è¿™æ ·ï¼Œå­ç»„ä»¶å°±ä¸éœ€è¦æ¸²æŸ“ä¸¤æ¬¡äº†ã€‚ç»„ä»¶çš„å‰©ä½™å‡½æ•°ä»å°†æ‰§è¡Œï¼ˆç»“æœå°†è¢«ä¸¢å¼ƒï¼‰ã€‚å¦‚æœä½ çš„æ¡ä»¶ä½äºæ‰€æœ‰`Hook`è°ƒç”¨ï¼Œä½ å¯ä»¥æ·»åŠ ä¸€ä¸ªæ—©ç‚¹çš„`return`æ¥å°½æ—©é‡æ–°å¯åŠ¨æ¸²æŸ“ã€‚

## ç–‘éš¾è§£ç­”
### æˆ‘å·²ç»æ›´æ–°äº†`state`ï¼Œä½†æ˜¯æ—¥å¿—ç»™æˆ‘çš„æ˜¯æ—§å€¼
åœ¨è¿è¡Œæ—¶è°ƒç”¨`set`å‡½æ•°ä¸èƒ½æ”¹å˜`state`ï¼š
```javascript
function handleClick() {
  console.log(count);  // 0

  setCount(count + 1); // Request a re-render with 1
  console.log(count);  // Still 0!

  setTimeout(() => {
    console.log(count); // Also 0!
  }, 5000);
}
```

è¿™æ˜¯å› ä¸º`state`çš„è¡Œä¸ºå°±åƒå¿«ç…§ã€‚æ›´æ–°`state`è¯·æ±‚ä½¿ç”¨æ–°çš„`state`å€¼è¿›è¡Œé‡æ¸²æŸ“ï¼Œä½†ä¸ä¼šå½±å“å·²ç»åœ¨è¿è¡Œä¸­çš„äº‹ä»¶å¤„ç†å™¨ä¸­çš„`count`å˜é‡ã€‚

å¦‚æœä½ éœ€è¦ä½¿ç”¨ä¸‹ä¸€ä¸ª`state`ï¼Œä½ å¯ä»¥åœ¨å°†å®ƒä¼ é€’ç»™`set`å‡½æ•°ä¹‹å‰æŠŠå®ƒä¿å­˜åˆ°ä¸€ä¸ªå˜é‡ä¸­ï¼š

```javascript
const nextCount = count + 1;
setCount(nextCount);

console.log(count);     // 0
console.log(nextCount); // 1
```

### æˆ‘å·²ç»æ›´æ–°äº†`state`ï¼Œä½†å±å¹•ä¸Šæ²¡æœ‰æ›´æ–°

å¦‚æœä¸‹ä¸€ä¸ª`state`å€¼ç­‰äºå‰ä¸€ä¸ª`state`å€¼ï¼ŒReactä¼šå¿½ç•¥ä½ çš„æ›´æ–°ï¼Œè¿™ç”±`Object.is`çš„æ¯”è¾ƒç»“æœæ¥å†³å®šã€‚è¿™ç»å¸¸å‘ç”Ÿåœ¨å½“ä½ åœ¨`state`ä¸­ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡æˆ–æ•°ç»„æ—¶ï¼š

```javascript
obj.x = 10;  // ğŸš© Wrong: mutating existing object
setObj(obj); // ğŸš© Doesn't do anything
```

ä½ ä¿®æ”¹ä¸€ä¸ªå·²ç»å­˜åœ¨çš„å¯¹è±¡`obj`è€Œä¸”æŠŠå®ƒä¼ é€’ç»™`setObj`ï¼Œæ‰€ä»¥Reactå¿½ç•¥äº†æ›´æ–°ã€‚ä¸ºäº†ä¿®å¤å®ƒï¼Œä½ éœ€è¦ç¡®å®šä½ åœ¨`state`ä¸­æ€»æ˜¯æ›¿æ¢å¯¹è±¡å’Œæ•°ç»„è€Œä¸æ˜¯ä¿®æ”¹ä»–ä»¬ï¼š

```javascript
// âœ… Correct: creating a new object
setObj({
  ...obj,
  x: 10
});
```

### æˆ‘æ”¶åˆ°ä¸€ä¸ªé”™è¯¯ï¼š"Too many re-renders"
ä½ å¯èƒ½æ”¶åˆ°ä¸€ä¸ªè¿™æ ·çš„é”™è¯¯ï¼š"Too many re-renders"ã€‚Reacté™åˆ¶äº†æ¸²æŸ“çš„æ¬¡æ•°é˜²æ­¢æ— é™å¾ªç¯ã€‚é€šå¸¸ï¼Œè¿™æ„å‘³ç€ä½ åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­æ— æ¡ä»¶çš„è®¾ç½®`state`ï¼Œæ‰€ä»¥ä½ çš„ç»„ä»¶è¿›å…¥äº†ä¸€ä¸ªå¾ªç¯ï¼šæ¸²æŸ“ï¼Œè®¾ç½®`state`ï¼ˆå¯¼è‡´äº†æ¸²æŸ“ï¼‰ï¼Œæ¸²æŸ“ï¼Œè®¾ç½®`state`ï¼ˆå¯¼è‡´äº†æ¸²æŸ“ï¼‰ï¼Œç­‰ç­‰ã€‚é€šå¸¸ï¼Œè¿™æ˜¯äº‹ä»¶å¤„ç†å™¨ä¸­çš„é”™è¯¯å¯¼è‡´çš„ï¼š
```javascript
// ğŸš© Wrong: calls the handler during render
return <button onClick={handleClick()}>Click me</button>

// âœ… Correct: passes down the event handler
return <button onClick={handleClick}>Click me</button>

// âœ… Correct: passes down an inline function
return <button onClick={(e) => handleClick(e)}>Click me</button>
```

å¦‚æœä½ æ²¡æœ‰å‘ç°è¿™ä¸ªé”™è¯¯çš„åŸå› ï¼Œåœ¨Consoleä¸Šç‚¹å‡»é”™è¯¯é™„è¿‘çš„ç®­å¤´ï¼Œå¯»æ‰¾JavaScriptå †æ ˆæ¥å‘ç°ç‰¹æ®Šçš„å¯¼è‡´é”™è¯¯çš„ç‰¹å®š`set`å‡½æ•°è°ƒç”¨ã€‚

### æˆ‘çš„åˆå§‹åŒ–å‡½æ•°æˆ–æ›´æ–°å‡½æ•°è¿è¡Œäº†ä¸¤æ¬¡
åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼ŒReactä¼šè°ƒç”¨ä¸¤æ¬¡ä½ çš„å‡½æ•°è€Œä¸æ˜¯ä¸€æ¬¡ï¼š

```javascript
function TodoList() {
  // This component function will run twice for every render.

  const [todos, setTodos] = useState(() => {
    // This initializer function will run twice during initialization.
    return createTodos();
  });

  function handleClick() {
    setTodos(prevTodos => {
      // This updater function will run twice for every click.
      return [...prevTodos, createTodo()];
    });
  }

  // ...
}
```

è¿™æ˜¯é¢„æ–™ä¸­çš„ï¼Œè€Œä¸”ä¸ä¼šç ´åä½ çš„ä»£ç ã€‚

è¿™æ˜¯åªåœ¨å¼€å‘ç¯å¢ƒä¸­çš„è¡Œä¸ºï¼Œç”¨æ¥å¸®åŠ©ä½ ä¿æŒç»„ä»¶çš„çº¯å‡€ã€‚Reactä½¿ç”¨å…¶ä¸­ä¸€ä¸ªè°ƒç”¨çš„ç»“æœï¼Œå¹¶ä¸”å¿½ç•¥å…¶ä»–è°ƒç”¨çš„ç»“æœã€‚åªè¦ä½ çš„ç»„ä»¶ã€åˆå§‹åŒ–å‡½æ•°ã€æ›´æ–°å‡½æ•°æ˜¯çº¯å‡€çš„ï¼Œå®ƒå°±ä¸ä¼šå½±å“ä½ çš„é€»è¾‘ã€‚ä½†æ˜¯ï¼Œå¦‚æœä»–ä»¬æ˜¯ä¸çº¯çš„ï¼Œè¿™èƒ½å¸®åŠ©ä½ å‘ç°é—®é¢˜ã€‚

æ¯”å¦‚ï¼Œåœ¨`state`ä¸­ï¼Œä¸çº¯çš„æ›´æ–°å‡½æ•°ä¿®æ”¹ä¸€ä¸ªæ•°ç»„ï¼š

```javascript
setTodos(prevTodos => {
  // ğŸš© Mistake: mutating state
  prevTodos.push(createTodo());
});
```

å› ä¸ºReactè°ƒç”¨ä½ çš„æ›´æ–°å‡½æ•°ä¸¤æ¬¡ï¼Œä½ ä¼šçœ‹åˆ°todoè¢«åŠ å…¥äº†ä¸¤æ¬¡ï¼Œæ‰€ä»¥ä½ å°†çŸ¥é“è¿™é‡Œæœ‰é—®é¢˜ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡æ›¿æ¢æ•°ç»„è€Œä¸æ˜¯ä¿®æ”¹å®ƒæ¥ä¿®å¤è¿™ä¸ªé”™è¯¯ã€‚

```javascript
setTodos(prevTodos => {
  // âœ… Correct: replacing with new state
  return [...prevTodos, createTodo()];
})
```

ç°åœ¨è¿™ä¸ªæ›´æ–°å‡½æ•°çº¯å‡€äº†ï¼Œå¤šè°ƒç”¨å®ƒä¸€æ¬¡ä¸ä¼šé€ æˆä¸åŒçš„è¡Œä¸ºã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆReactè°ƒç”¨å®ƒä¸¤æ¬¡å¸®ä½ å‘ç°é—®é¢˜ã€‚åªæœ‰ç»„ä»¶ï¼Œåˆå§‹åŒ–å‡½æ•°ï¼Œæ›´æ–°å‡½æ•°éœ€è¦ä¿æŒçº¯å‡€ã€‚äº‹ä»¶å¤„ç†å™¨ä¸éœ€è¦çº¯å‡€ï¼Œæ‰€ä»¥Reactä¸ä¼šè°ƒç”¨ä½ çš„äº‹ä»¶å¤„ç†å™¨ä¸¤æ¬¡ã€‚

### æˆ‘å°è¯•æŠŠå‡½æ•°è®¾ç½®ç»™`state`ï¼Œä½†å®ƒè¢«è°ƒç”¨äº†

ä½ ä¸èƒ½åƒè¿™æ ·æŠŠå‡½æ•°èµ‹å€¼ç»™`state`ï¼š

```javascript
const [fn, setFn] = useState(someFunction);

function handleClick() {
  setFn(someOtherFunction);
}
```

å› ä¸ºä½ ä¼ é€’äº†å‡½æ•°ï¼ŒReactçŒœæµ‹`someFunction`æ˜¯ä¸ªåˆå§‹åŒ–å‡½æ•°ï¼Œè€Œ`someOtherFunction`æ˜¯ä¸ªæ›´æ–°å‡½æ•°ï¼Œæ‰€ä»¥å®ƒå°è¯•è°ƒç”¨ä»–ä»¬å¹¶å­˜å‚¨ç»“æœã€‚åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œä¸ºäº†å­˜å‚¨å‡½æ•°ï¼Œä½ ä¸å¾—ä¸åœ¨ä»–ä»¬ä¹‹å‰åŠ ä¸Š()=>ã€‚ç„¶åReactä¼šå­˜å‚¨ä½ è°ƒç”¨çš„å‡½æ•°ã€‚

```javascript
const [fn, setFn] = useState(() => someFunction);

function handleClick() {
  setFn(() => someOtherFunction);
}
```

---
## æˆ‘çš„æ€»ç»“
- è¦åœ¨é¡¶å±‚è°ƒç”¨ï¼Œä¸è¦åœ¨å¾ªç¯æˆ–æ¡ä»¶è¯­å¥ä¸­è°ƒç”¨å®ƒã€‚
- åˆå§‹åŒ–å‡½æ•°åœ¨å¼€å‘ç¯å¢ƒä¸‹ä¼šè°ƒç”¨ä¸¤æ¬¡ï¼Œä½†åœ¨ç”Ÿäº§ç¯å¢ƒåªè°ƒç”¨ä¸€æ¬¡ï¼Œè¿™æ˜¯æ­£å¸¸çš„ã€‚ç›®çš„æ˜¯è¾…åŠ©åˆ¤æ–­åˆå§‹åŒ–å‡½æ•°æ˜¯å¦ä¸ºçº¯å‡½æ•°ã€‚
- åˆå§‹åŒ–å‡½æ•°å¿…é¡»æ˜¯çº¯å‡½æ•°ï¼Œè€Œä¸”ä¸æ¥å—å‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„`state`å€¼ã€‚æ›´æ–°å‡½æ•°å¿…é¡»æ˜¯çº¯å‡½æ•°ï¼Œåªæ¥å—å¾…å¤„ç†çš„`state`ä½œä¸ºå®ƒå”¯ä¸€çš„å‚æ•°ï¼Œæ²¡æœ‰è¿”å›å€¼ã€‚
- Reactä¼šé€šè¿‡Object.isæ¥æ¯”è¾ƒæ–°æ—§å€¼æ˜¯å¦ç›¸åŒï¼Œæ„å‘³ç€å¦‚æœ`state`æ˜¯å¯¹è±¡æˆ–æ•°ç»„ï¼Œåªåšæµ…æ¯”è¾ƒã€‚
- Reactæ›´æ–°`state`æ—¶æ˜¯æ‰¹é‡æ›´æ–°çš„ã€‚[å¦‚ä½•åšæ‰¹é‡æ›´æ–°çš„](https://overreacted.io/react-as-a-ui-runtime/#batching)ã€‚ï¼ˆ[è¿™ç¯‡æ–‡æ¡£çš„å…¨éƒ¨ç¿»è¯‘](https://thoamsy.github.io/blogs/react-as-a-runtime/)ï¼‰
- `set`å‡½æ•°æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚æœåœ¨`set`åç«‹å³è¯»å–`state`å€¼ï¼Œä¸èƒ½ä¿è¯èƒ½å¤Ÿè·å–åˆ°æœ€æ–°çš„`state`ã€‚å¦‚æœéœ€è¦åœ¨æ›´æ–°åç«‹å³è®¿é—®`state`ï¼Œå¯ä»¥ä½¿ç”¨`useEffect`é’©å­å‡½æ•°æ¥å®ç°ã€‚
- 




